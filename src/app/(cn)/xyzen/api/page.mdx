# API 参考

Xyzen 提供了完整的 REST API 和 WebSocket 接口，用于管理 Agent、会话、提供商和 MCP 服务器。本文档详细介绍了所有可用的 API 端点。

<Note>
**基础 URL**: `/xyzen/api/v1`

**认证**: 所有需要用户上下文的请求都需要有效的授权令牌。令牌通过 HTTP header `Authorization: Bearer <token>` 传递。

**API 文档**: 启动服务后，可以访问 Swagger UI 获取交互式 API 文档：`http://localhost:48196/xyzen/api/docs`
</Note>

## 认证（Auth）

### 获取认证状态

获取认证服务的配置状态，确认系统已正确配置身份验证。

```bash
GET /auth/status
```

**响应**
```json
{
  "is_configured": true,
  "provider": "casdoor",
  "message": "认证服务已配置 (casdoor)"
}
```

### 获取认证配置

返回认证提供商的配置信息（不包含敏感密钥）。前端可以使用这些信息构造登录链接。

```bash
GET /auth/config
```

**响应**
```json
{
  "provider": "casdoor",
  "issuer": "https://auth.example.com",
  "audience": "client-id",
  "jwks_uri": "https://auth.example.com/.well-known/jwks.json",
  "algorithm": "RS256"
}
```

**支持的认证提供商**：
- **Casdoor** - 开源身份管理平台
- **Bohrium** - 专业科研计算平台
- **BohrApp** - 应用集成平台

---

## 提供商（Providers）

提供商用于管理 LLM API 凭证。每个用户可以配置多个提供商，支持不同的 AI 服务商。

### 获取提供商模板

获取所有支持的 LLM 提供商的配置模板。这些模板帮助用户了解每个提供商需要哪些配置字段。

```bash
GET /providers/templates
```

**响应**
```json
[
  {
    "name": "OpenAI",
    "icon": "openai",
    "fields": [
      {
        "key": "api_key",
        "label": "API Key",
        "required": true,
        "type": "password"
      }
    ]
  },
  {
    "name": "Azure OpenAI",
    "icon": "azure",
    "fields": [...]
  }
]
```

### 获取当前用户的提供商

获取当前认证用户拥有和可访问的所有提供商。系统提供商的敏感信息会被掩盖。

```bash
GET /providers/me
```

**响应**
```json
[
  {
    "id": "uuid-here",
    "name": "My OpenAI",
    "provider_type": "openai",
    "key": "••••••••",
    "api": "https://api.openai.com/v1",
    "is_default": true,
    "is_system": false,
    "created_at": "2025-01-01T12:00:00Z"
  }
]
```

### 创建新提供商

为当前用户创建一个新的 LLM 提供商。如果这是用户的第一个提供商，它会自动设为默认。

```bash
POST /providers
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "My OpenAI Account",
  "provider_type": "openai",
  "key": "sk-...",
  "api": "https://api.openai.com/v1"
}
```

**响应** (201 Created)
```json
{
  "id": "uuid-here",
  "name": "My OpenAI Account",
  "provider_type": "openai",
  "is_default": true,
  "created_at": "2025-01-01T12:00:00Z"
}
```

### 更新提供商

更新现有的提供商配置。可以修改名称、API Key、端点等信息。

```bash
PATCH /providers/{provider_id}
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Updated Provider Name",
  "key": "new-api-key"
}
```

### 删除提供商

删除指定的提供商。删除后无法恢复。

```bash
DELETE /providers/{provider_id}
Authorization: Bearer <token>
```

---

## Agent（智能助手）

Agent 是 Xyzen 中的核心概念。每个 Agent 都拥有自己的系统提示、模型配置和可用工具。

### 创建 Agent

为当前用户创建一个新的 Agent。Agent 会与指定的提供商和 MCP 服务器关联。

```bash
POST /agents
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Research Assistant",
  "description": "助手用于研究论文分析",
  "avatar": "https://...",
  "tags": ["research", "academic"],
  "model": "gpt-4",
  "temperature": 0.7,
  "prompt": "你是一个专业的研究助手...",
  "provider_id": "uuid-here",
  "require_tool_confirmation": true,
  "mcp_server_ids": ["mcp-uuid-1", "mcp-uuid-2"]
}
```

**参数说明**：
- `name` - Agent 的名称（必填）
- `description` - Agent 的描述（可选）
- `avatar` - Agent 的头像 URL（可选）
- `model` - 使用的 LLM 模型名称（可选）
- `temperature` - LLM 的温度参数，0-1 之间（可选，默认 0.7）
  - 接近 0：更加确定性和准确
  - 接近 1：更加创意和多样化
- `prompt` - Agent 的系统提示词（可选）
- `provider_id` - 关联的提供商 ID（可选）
- `require_tool_confirmation` - 调用工具前是否需要用户确认（默认 false）
- `mcp_server_ids` - 关联的 MCP 服务器 ID 列表（可选）

**响应** (201 Created)
```json
{
  "id": "agent-uuid",
  "name": "Research Assistant",
  "model": "gpt-4",
  "provider_id": "provider-uuid",
  "created_at": "2025-01-01T12:00:00Z",
  "updated_at": "2025-01-01T12:00:00Z"
}
```

### 获取所有 Agent

获取当前用户拥有的所有 Agent。包括基本信息和关联的 MCP 服务器列表。

```bash
GET /agents
Authorization: Bearer <token>
```

**响应**
```json
[
  {
    "id": "agent-uuid-1",
    "name": "Research Assistant",
    "description": "论文分析助手",
    "model": "gpt-4",
    "temperature": 0.7,
    "require_tool_confirmation": true,
    "mcp_servers": [
      {
        "id": "mcp-uuid",
        "name": "Scientific Tools",
        "url": "http://localhost:3000/mcp",
        "status": "online",
        "tools": [...]
      }
    ],
    "created_at": "2025-01-01T12:00:00Z"
  }
]
```

### 获取单个 Agent

获取指定 Agent 的详细信息。

```bash
GET /agents/{agent_id}
Authorization: Bearer <token>
```

### 更新 Agent

修改 Agent 的配置，包括名称、描述、系统提示、关联的 MCP 服务器等。

```bash
PATCH /agents/{agent_id}
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Updated Agent Name",
  "temperature": 0.8,
  "mcp_server_ids": ["new-mcp-uuid-1", "new-mcp-uuid-2"]
}
```

### 删除 Agent

删除指定的 Agent。删除后所有关联的会话仍会保留。

```bash
DELETE /agents/{agent_id}
Authorization: Bearer <token>
```

---

## 会话（Sessions）

会话代表与 Agent 的一次交互对话。每个会话包含多个主题（Topic），每个主题包含对话历史。

### 创建会话

为指定 Agent 创建一个新会话。系统会自动创建一个名为"新的聊天"的初始主题。

```bash
POST /sessions
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "论文分析 - 机器学习综述",
  "description": "分析最新的机器学习综述论文",
  "agent_id": "agent-uuid",
  "is_active": true
}
```

**响应** (201 Created)
```json
{
  "id": "session-uuid",
  "name": "论文分析 - 机器学习综述",
  "agent_id": "agent-uuid",
  "created_at": "2025-01-01T12:00:00Z",
  "updated_at": "2025-01-01T12:00:00Z"
}
```

### 获取所有会话

获取当前用户的所有会话及其包含的主题。

```bash
GET /sessions
Authorization: Bearer <token>
```

**响应**
```json
[
  {
    "id": "session-uuid",
    "name": "论文分析",
    "agent_id": "agent-uuid",
    "topics": [
      {
        "id": "topic-uuid",
        "name": "新的聊天",
        "message_count": 5,
        "created_at": "2025-01-01T12:00:00Z"
      }
    ],
    "created_at": "2025-01-01T12:00:00Z"
  }
]
```

### 获取单个会话

获取指定会话的详细信息。

```bash
GET /sessions/{session_id}
Authorization: Bearer <token>
```

### 更新会话

修改会话的名称、描述或激活状态。

```bash
PATCH /sessions/{session_id}
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Updated Session Name",
  "description": "Updated description"
}
```

### 删除会话

删除指定会话及其所有主题和消息。

```bash
DELETE /sessions/{session_id}
Authorization: Bearer <token>
```

---

## 主题（Topics）

主题是会话内的子分组，用于组织对话内容。一个会话可以包含多个主题。

### 创建主题

在指定会话中创建一个新主题。

```bash
POST /sessions/{session_id}/topics
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "关于模型架构的讨论"
}
```

**响应** (201 Created)
```json
{
  "id": "topic-uuid",
  "name": "关于模型架构的讨论",
  "session_id": "session-uuid",
  "message_count": 0,
  "created_at": "2025-01-01T12:00:00Z"
}
```

### 获取主题消息

获取指定主题的所有消息。支持分页。

```bash
GET /sessions/{session_id}/topics/{topic_id}/messages
Authorization: Bearer <token>
```

**响应**
```json
[
  {
    "id": "message-uuid",
    "role": "user",
    "content": "请分析这篇论文的核心贡献",
    "created_at": "2025-01-01T12:00:00Z"
  },
  {
    "id": "message-uuid",
    "role": "assistant",
    "content": "这篇论文的核心贡献包括...",
    "created_at": "2025-01-01T12:00:01Z"
  }
]
```

### 删除主题

删除指定主题及其所有消息。

```bash
DELETE /sessions/{session_id}/topics/{topic_id}
Authorization: Bearer <token>
```

---

## MCP 服务器（MCPs）

MCP（Model Context Protocol）服务器提供了额外的工具和数据源，Agent 可以使用这些工具来增强其能力。

### 获取所有 MCP 服务器

获取当前用户配置的所有 MCP 服务器。

```bash
GET /mcps
Authorization: Bearer <token>
```

**响应**
```json
[
  {
    "id": "mcp-uuid",
    "name": "Scientific Tools",
    "description": "用于科学计算的工具集",
    "url": "http://localhost:3000/mcp",
    "status": "online",
    "tools": [
      {
        "name": "search_papers",
        "description": "搜索科学论文",
        "input_schema": {...}
      }
    ],
    "last_checked_at": "2025-01-01T12:00:00Z"
  }
]
```

### 添加 MCP 服务器

为当前用户添加一个新的 MCP 服务器。系统会自动检查服务器的健康状态并获取工具列表。

```bash
POST /mcps
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Local Tools",
  "description": "本地工具集",
  "url": "http://localhost:3000/mcp",
  "token": "optional-auth-token"
}
```

**参数说明**：
- `name` - MCP 服务器的名称（必填）
- `description` - MCP 服务器的描述（可选）
- `url` - MCP 服务器的连接地址（必填）
- `token` - 连接令牌，如果服务器需要认证（可选）

**响应** (201 Created)
```json
{
  "id": "mcp-uuid",
  "name": "Local Tools",
  "url": "http://localhost:3000/mcp",
  "status": "online",
  "tools": [
    {
      "name": "calculator",
      "description": "执行数学运算"
    }
  ]
}
```

### 获取 MCP 服务器健康状态

检查指定 MCP 服务器的连接状态和工具列表。

```bash
GET /mcps/{mcp_id}/health
Authorization: Bearer <token>
```

**响应**
```json
{
  "status": "online",
  "response_time_ms": 45,
  "tools_count": 8
}
```

### 更新 MCP 服务器

修改 MCP 服务器的配置。

```bash
PATCH /mcps/{mcp_id}
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Updated Name",
  "token": "new-token"
}
```

### 删除 MCP 服务器

删除指定的 MCP 服务器。删除后，关联的 Agent 将无法访问该服务器的工具。

```bash
DELETE /mcps/{mcp_id}
Authorization: Bearer <token>
```

### 测试 MCP 工具

测试 MCP 服务器上的特定工具。这有助于验证工具是否正常工作。

```bash
POST /mcps/{mcp_id}/tools/{tool_name}/test
Authorization: Bearer <token>
Content-Type: application/json

{
  "parameters": {
    "query": "search term"
  }
}
```

**响应**
```json
{
  "success": true,
  "result": "Tool execution result",
  "execution_time_ms": 234
}
```

---

## WebSocket 接口

WebSocket 接口用于实时的流式聊天和事件推送。

### 连接聊天会话

建立一个 WebSocket 连接来与 Agent 进行实时对话。

```
WS /ws/v1/chat/sessions/{session_id}/topics/{topic_id}
Authorization: Bearer <token>
```

**连接后发送消息**
```json
{
  "type": "message",
  "content": "请分析这篇论文",
  "require_tool_confirmation": false
}
```

**接收流式响应**
```json
{
  "type": "token",
  "content": "这篇论文",
  "timestamp": "2025-01-01T12:00:00Z"
}
```

**工具调用请求**
```json
{
  "type": "tool_call",
  "tool_name": "search_papers",
  "arguments": {
    "query": "machine learning"
  },
  "requires_confirmation": true
}
```

**完成事件**
```json
{
  "type": "execution_complete",
  "final_message": "完整的 AI 响应内容",
  "execution_time_ms": 2500
}
```

---

## 错误处理

所有 API 端点都遵循统一的错误响应格式。

### 标准错误响应

```json
{
  "detail": "描述性的错误信息",
  "status_code": 400,
  "error_code": "INVALID_INPUT"
}
```

### 常见 HTTP 状态码

| 状态码 | 含义 | 说明 |
|--------|------|------|
| 200 | OK | 请求成功 |
| 201 | Created | 资源创建成功 |
| 204 | No Content | 请求成功但无返回内容 |
| 400 | Bad Request | 请求参数错误 |
| 401 | Unauthorized | 未认证或令牌过期 |
| 403 | Forbidden | 无权访问该资源 |
| 404 | Not Found | 资源不存在 |
| 500 | Internal Server Error | 服务器内部错误 |

### 认证错误

```json
{
  "detail": "Invalid token",
  "status_code": 401,
  "error_code": "INVALID_TOKEN"
}
```

### 资源冲突

```json
{
  "detail": "Provider not found",
  "status_code": 404,
  "error_code": "RESOURCE_NOT_FOUND"
}
```

---

## 速率限制

Xyzen API 目前不实施硬速率限制，但请合理控制请求频率，避免对服务造成压力。建议：
- 单个客户端每秒不超过 100 次请求
- WebSocket 连接中每秒消息不超过 10 条
- 大批量操作应使用后台处理

---

## 分页

支持分页的端点通常接受以下查询参数：

```bash
GET /endpoint?page=1&limit=20&sort=-created_at
```

| 参数 | 说明 |
|------|------|
| `page` | 页码，从 1 开始（默认 1） |
| `limit` | 每页结果数量（默认 20，最大 100） |
| `sort` | 排序字段（前置 `-` 表示降序） |

---

## 完整示例

### 场景：使用 Agent 分析论文

1. **创建提供商**（如果还没有）
```bash
curl -X POST http://localhost:48196/xyzen/api/v1/providers \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "My OpenAI",
    "provider_type": "openai",
    "key": "sk-..."
  }'
```

2. **创建 Agent**
```bash
curl -X POST http://localhost:48196/xyzen/api/v1/agents \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Paper Analyzer",
    "model": "gpt-4",
    "provider_id": "PROVIDER_ID",
    "prompt": "你是一个论文分析专家..."
  }'
```

3. **创建会话**
```bash
curl -X POST http://localhost:48196/xyzen/api/v1/sessions \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "ML Survey Analysis",
    "agent_id": "AGENT_ID"
  }'
```

4. **通过 WebSocket 发送消息**
```javascript
const ws = new WebSocket(
  'ws://localhost:48196/xyzen/ws/v1/chat/sessions/SESSION_ID/topics/TOPIC_ID',
  ['Authorization', 'Bearer YOUR_TOKEN']
);

ws.onopen = () => {
  ws.send(JSON.stringify({
    type: 'message',
    content: '请分析这篇论文的核心贡献'
  }));
};

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  console.log(message);
};
```

---

## 相关资源

- [高级功能](/xyzen/advanced) - 了解MCP 集成等高级特性
- [部署指南](/xyzen/deploy) - 学习如何本地部署 Xyzen
- [快速开始](/xyzen/quickstart) - 新用户入门指南
- [FAQ](/xyzen/faq) - 常见问题解答

