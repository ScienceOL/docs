# Xyzen æ¶æ„è®¾è®¡

Xyzen é‡‡ç”¨ç°ä»£åŒ–çš„åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œé€šè¿‡æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»å’Œæ¨¡å—åŒ–è®¾è®¡ï¼Œå®ç°äº†ä¸€ä¸ªé«˜æ•ˆã€å¯æ‰©å±•çš„ AI æœåŠ¡å¹³å°ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»ç³»ç»Ÿçš„æ•´ä½“æ¶æ„ã€æ ¸å¿ƒæ¨¡å—ã€æ•°æ®æµä»¥åŠæŠ€æœ¯é€‰å‹ã€‚

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```mermaid
graph TB
    Client["ğŸ–¥ï¸ å®¢æˆ·ç«¯<br/>Web / Desktop"]
    
    subgraph "API å±‚"
        REST["REST API<br/>/xyzen/api/v1/*"]
        WS["WebSocket<br/>/xyzen/ws/v1/*"]
        
    end
    
    subgraph "ä¸­é—´ä»¶å±‚"
        Auth["ğŸ” èº«ä»½è®¤è¯ä¸­é—´ä»¶<br/>JWT Token Validation"]
    end
    
    subgraph "æœåŠ¡å±‚"
        AgentService["Agent Service<br/>agent_service.py"]
        ChatService["Chat Service<br/>chat/"]
        MCPService["MCP Service<br/>mcp.py"]
        ProviderService["Provider Service<br/>providers/"]
        AuthService["Auth Service<br/>auth/"]
        ConsumeService["Consumption Service<br/>consume.py"]
    end
    
    subgraph "æ•°æ®å±‚"
        Repository["Repository Layer<br/>repo/*"]
        SQLModel["SQLModel ORM<br/>models/*"]
        PostgreSQL["ğŸ—„ï¸ PostgreSQL"]
        SQLite["ğŸ“Š SQLite<sub>optional</sub>"]
    end
    
    subgraph "å¤–éƒ¨é›†æˆ"
        LLMProviders["ğŸ¤– LLM Providers<br/>OpenAI, Claude, etc."]
        MCPServers["ğŸ”§ MCP Servers<br/>Tool Ecosystem"]
        LangChain["ğŸ”— LangChain<br/>Agent Framework"]
        LangGraph["ğŸ“Š LangGraph<br/>Workflow Engine"]
        Smithery["ğŸ“¦ Smithery Registry<br/>Tool Discovery"]
    end
    
    Client -->|HTTP/WebSocket| REST
    Client -->|WebSocket| WS
    
    REST --> Auth
    WS --> Auth
    
    Auth --> ChatService
    Auth --> AgentService
    Auth --> MCPService
    Auth --> ConsumeService
    
    ChatService --> LangChain
    ChatService --> LangGraph
    ChatService --> ProviderService
    ChatService --> MCPService
    
    AgentService --> Repository
    ProviderService --> Repository
    MCPService --> Repository
    ConsumeService --> Repository
    
    Repository --> SQLModel
    SQLModel --> PostgreSQL
    SQLModel --> SQLite
    
    LangChain --> LLMProviders
    LangGraph --> MCPServers
    MCPService --> Smithery
    
    style Client fill:#e1f5fe
    style REST fill:#fff3e0
    style WS fill:#fff3e0
    style Auth fill:#f3e5f5
    
    style AgentService fill:#fce4ec
    style ChatService fill:#fce4ec
    style MCPService fill:#fce4ec
    style PostgreSQL fill:#c8e6c9
    style LLMProviders fill:#bbdefb
    style LangChain fill:#bbdefb
```

## åˆ†å±‚æ¶æ„è¯¦è§£

### 1. è¡¨ç°å±‚ (Presentation Layer)

è¡¨ç°å±‚ä½œä¸ºç³»ç»Ÿçš„å…¥å£ç‚¹ï¼Œå¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„æ‰€æœ‰è¯·æ±‚ã€‚

#### API å…¥å£ç‚¹

**REST API è·¯ç”±**

```
/xyzen/api/v1/
  â”œâ”€â”€ /agents          # ä»£ç†ç®¡ç†
  â”œâ”€â”€ /sessions        # ä¼šè¯ç®¡ç†
  â”œâ”€â”€ /topics          # ä¸»é¢˜ç®¡ç†
  â”œâ”€â”€ /mcps            # MCP æœåŠ¡å™¨ç®¡ç†
  â”œâ”€â”€ /providers       # æä¾›è€…ç®¡ç†
  â””â”€â”€ /auth            # èº«ä»½è®¤è¯
```

**WebSocket å…¥å£**

```
/xyzen/ws/v1/
  â””â”€â”€ /chat/[session_id]  # å®æ—¶èŠå¤©è¿æ¥
```

**å¥åº·æ£€æŸ¥**

```
/xyzen/api/health  # æœåŠ¡å¥åº·çŠ¶æ€æ£€æŸ¥
```

#### FastAPI åº”ç”¨ç»“æ„

```python
# FastAPI åº”ç”¨åˆå§‹åŒ–æµç¨‹
app = FastAPI(
    title="Xyzen FastAPI Service",
    lifespan=lifespan,  # ç”Ÿå‘½å‘¨æœŸç®¡ç†
    docs_url="/xyzen/api/docs",
)

# CORS ä¸­é—´ä»¶
app.add_middleware(CORSMiddleware, allow_origins=["*"])

# æ ¹è·¯ç”±å™¨
app.include_router(root_router, prefix="/xyzen")

# MCP è·¯ç”±è‡ªåŠ¨æ³¨å†Œ
app.router.routes.extend(setup_mcp_routes(app.state))
```

### 2. ä¸­é—´ä»¶å±‚ (Middleware Layer)

ä¸­é—´ä»¶è´Ÿè´£æ¨ªåˆ‡å…³æ³¨ç‚¹çš„å¤„ç†ï¼Œåœ¨è¯·æ±‚-å“åº”å‘¨æœŸä¸­æ‰§è¡Œç»Ÿä¸€çš„å¤„ç†é€»è¾‘ã€‚

#### èº«ä»½è®¤è¯ä¸­é—´ä»¶ (auth/)

éªŒè¯ Bearer Token JWTï¼Œæå–ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼š
- æ”¯æŒå¤šä¸ªè®¤è¯æä¾›è€… (Casdoor, Bohrium, BohrApp)
- ä» Token ä¸­æå– \`user_id\` å’Œ \`provider\`
- ä¸ºåç»­æœåŠ¡å±‚æ³¨å…¥å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡

#### æ•°æ®åº“è¿æ¥ä¸­é—´ä»¶ (database/)

ç®¡ç† SQLAlchemy æ•°æ®åº“è¿æ¥æ± ï¼š
- åˆ›å»º \`AsyncSessionLocal\` è¿æ¥
- ä½¿ç”¨ FastAPI çš„ \`Depends\` æœºåˆ¶ä¾èµ–æ³¨å…¥
- æ”¯æŒäº‹åŠ¡ç®¡ç†å’Œè‡ªåŠ¨å›æ»š

#### æ—¥å¿—ä¸­é—´ä»¶ (logger/)

ç»“æ„åŒ–æ—¥å¿—è®°å½•ï¼š
- è¯·æ±‚å…¥å£æ—¥å¿—
- é”™è¯¯å †æ ˆè·Ÿè¸ª
- æœåŠ¡å¯åŠ¨å’Œå…³é—­æ—¥å¿—

#### åŠ¨æ€ MCP æœåŠ¡å™¨ä¸­é—´ä»¶ (dynamic_mcp_server.py)

åŠ¨æ€åˆ›å»ºå’ŒæŒ‚è½½ MCP HTTP æœåŠ¡å™¨ï¼š
- ä¸ºæ¯ä¸ªæ³¨å†Œçš„ MCP æœåŠ¡å™¨åˆ›å»ºç‹¬ç«‹çš„ FastMCP åº”ç”¨
- å¤„ç† MCP ç”Ÿå‘½å‘¨æœŸç®¡ç†
- é”™è¯¯éš”ç¦»å’Œæ¢å¤

### 3. API å¤„ç†å±‚ (Handler Layer)

å¤„ç†å±‚åŒ…å«æ‰€æœ‰çš„ HTTP è·¯ç”±å¤„ç†å™¨å’Œ WebSocket äº‹ä»¶å¤„ç†å™¨ã€‚

#### REST API å¤„ç†å™¨ (handler/api/v1/)

| æ¨¡å— | èŒè´£ | æ ¸å¿ƒç«¯ç‚¹ |
|-----|------|--------|
| **agents.py** | ä»£ç† CRUD å’Œé…ç½® | POST /agentsï¼ŒGET /agents/idï¼ŒPUT /agents/idï¼ŒDELETE /agents/id |
| **sessions.py** | ä¼šè¯å’Œä¸»é¢˜ç®¡ç† | POST /sessionsï¼ŒGET /sessionsï¼Œè‡ªåŠ¨åˆ›å»ºé»˜è®¤ä¸»é¢˜ |
| **topics.py** | ä¸»é¢˜å’Œæ¶ˆæ¯ | GET /topics/id/messagesï¼ŒDELETE /topics/id |
| **mcps.py** | MCP æœåŠ¡å™¨é›†æˆ | GET /mcpsï¼ŒPOST /mcps/tools/testï¼ŒSmithery æ¿€æ´» |
| **providers.py** | æä¾›è€…é…ç½® | GET /providersï¼ŒPOST /providersï¼ŒPUT /providers/idï¼ŒDELETE /providers/id |
| **auth.py** | è®¤è¯çŠ¶æ€ | GET /auth/statusï¼ŒGET /auth/config |

#### WebSocket å¤„ç†å™¨ (handler/ws/v1/)

å®æ—¶èŠå¤©é€šä¿¡é€šé“ï¼š
- è¿æ¥å»ºç«‹ä¸å…³é—­
- æ¶ˆæ¯å‘é€å’Œæ¥æ”¶
- æµå¼å“åº”å¤„ç†

#### å†…ç½®ä»£ç†å¤„ç†å™¨ (handler/builtin_agents/)

é¢„å®šä¹‰çš„ç³»ç»Ÿçº§ä»£ç†ï¼š
- æ³¨å†Œè¡¨ç®¡ç†
- ä»£ç†å‘ç°å’ŒåŠ è½½
- ä»£ç†å¯åŠ¨æ—¶æ•°æ®åº“ç§å­åŒ–

### 4. æœåŠ¡å±‚ (Service Layer)

æœåŠ¡å±‚åŒ…å«ä¸šåŠ¡é€»è¾‘å’Œå¤æ‚çš„è®¡ç®—ï¼Œæ˜¯åº”ç”¨çš„æ ¸å¿ƒé€»è¾‘æ‰€åœ¨ã€‚

#### Agent Service (core/agent_service.py)

ç»Ÿä¸€çš„ä»£ç†ç®¡ç†æœåŠ¡ï¼š
- `UnifiedAgentRead` æ¨¡å‹ç”¨äºè¯»å–å¸¸è§„ä»£ç†å’Œå›¾ä»£ç†
- ä»£ç†ç±»å‹æ£€æµ‹ (regular vs graph vs builtin)
- ä»£ç†éªŒè¯å’Œé…ç½®åŠ è½½

#### Chat Service (core/chat/)

å¯¹è¯æ‰§è¡Œå¼•æ“ï¼š
- ä¸ LangChain é›†æˆç”¨äºæ ‡å‡† LLM è°ƒç”¨
- ä¸ LangGraph é›†æˆç”¨äºå¤æ‚å·¥ä½œæµ
- æµå¼å“åº”å¤„ç†
- å·¥å…·è°ƒç”¨å’Œç¡®è®¤æœºåˆ¶

#### MCP Service (core/mcp.py)

MCP (Model Context Protocol) æœåŠ¡ï¼š
- MCP æœåŠ¡å™¨å®¢æˆ·ç«¯ç®¡ç†
- Smithery æ³¨å†Œè¡¨é›†æˆ
- å·¥å…·çŠ¶æ€æ£€æŸ¥å’Œå¥åº·æ£€æµ‹
- å¼‚æ­¥å¹¿æ’­æ›´æ–°

#### Provider Service (core/providers/)

LLM æä¾›è€…ç®¡ç†ï¼š
- æä¾›è€…åˆå§‹åŒ– (`initialize_providers_on_startup`)
- å‡­è¯å®‰å…¨å­˜å‚¨å’Œæ©ç 
- å¤šæä¾›è€…æ”¯æŒ (OpenAI, Azure, Anthropic, Google)
- æ¨¡æ¿ç®¡ç†

#### Auth Service (core/auth/)

èº«ä»½è®¤è¯å’Œæˆæƒï¼š
- Token éªŒè¯
- ç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†
- å¤šæä¾›è€…è®¤è¯

#### Consumption Service (core/consume.py)

ä½¿ç”¨é‡è·Ÿè¸ªå’Œè®¡è´¹ï¼š
- è®°å½•æ¯æ¬¡ API è°ƒç”¨çš„æ¶ˆè´¹
- è¿œç¨‹è®¡è´¹é›†æˆ (Bohrium)
- æ¶ˆè´¹è®°å½•æŒä¹…åŒ–
- å¹‚ç­‰æ€§ä¿è¯

### 5. æ•°æ®å±‚ (Data Layer)

#### Repository å±‚ (repo/)

æ•°æ®è®¿é—®æŠ½è±¡ï¼š

| æ–‡ä»¶ | åŠŸèƒ½ |
|-----|------|
| agent.py | Agent CRUD |
| session.py | Session/Topic CRUD |
| message.py | Message CRUD |
| provider.py | Provider CRUD |
| mcp.py | MCP æœåŠ¡å™¨ CRUD |
| consume.py | ConsumeRecord CRUD |
| graph.py | GraphAgent CRUD |

Repository æ¨¡å¼çš„å¥½å¤„ï¼š
- è§£è€¦ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®è®¿é—®
- æ”¯æŒå•å…ƒæµ‹è¯•å’Œ Mock
- ä¾¿äºåˆ‡æ¢æ•°æ®æº

#### SQLModel ORM (models/)

ç±»å‹å®‰å…¨çš„ ORM æ¨¡å‹ï¼ŒåŸºäº Pydantic V2 å’Œ SQLAlchemy 2.0ï¼š

```python
class Agent(SQLModel, table=True):
    id: UUID = Field(default_factory=uuid4, primary_key=True)
    name: str
    description: str | None = None
    temperature: float | None = None
    prompt: str | None = None
    user_id: str = Field(index=True)
    provider_id: UUID | None = Field(index=True)
    require_tool_confirmation: bool = False
    created_at: datetime  # TIMESTAMP with timezone
    updated_at: datetime  # TIMESTAMP with timezone
```

#### æ•°æ®åº“æ”¯æŒ

**PostgreSQL** (ç”Ÿäº§ç¯å¢ƒ)
- å®Œæ•´çš„äº‹åŠ¡æ”¯æŒ
- JSONB ç”¨äºå­˜å‚¨å¤æ‚ç»“æ„
- å…¨æ–‡æœç´¢èƒ½åŠ›
- é«˜å¹¶å‘æ€§èƒ½

**SQLite** (å¼€å‘ç¯å¢ƒ)
- æ— éœ€å¤–éƒ¨æœåŠ¡
- å¿«é€Ÿæœ¬åœ°å¼€å‘

## æ ¸å¿ƒæ•°æ®æ¨¡å‹

### æ•°æ®æ¨¡å‹å…³ç³»

ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®æ¨¡å‹åŒ…æ‹¬ä»¥ä¸‹å®ä½“åŠå…¶å…³ç³»ï¼š

**ç”¨æˆ·ä¸èµ„æºå…³ç³»**
- ç”¨æˆ·æ‹¥æœ‰å¤šä¸ªä»£ç† (Agent)
- ç”¨æˆ·åˆ›å»ºå¤šä¸ªä¼šè¯ (Session)
- ç”¨æˆ·åˆ›å»ºå¤šä¸ªå›¾ä»£ç† (GraphAgent)
- ç”¨æˆ·ç”Ÿæˆæ¶ˆè´¹è®°å½• (ConsumeRecord)

**ä»£ç†ä¸é…ç½®å…³ç³»**
- ä»£ç†ä½¿ç”¨å¤šä¸ª MCP æœåŠ¡å™¨
- ä»£ç†å…³è”ä¸€ä¸ªæä¾›è€… (Provider)

**ä¼šè¯å±‚çº§å…³ç³»**
- ä¼šè¯åŒ…å«å¤šä¸ªä¸»é¢˜ (Topic)
- ä¸»é¢˜åŒ…å«å¤šä¸ªæ¶ˆæ¯ (Message)

**å·¥ä½œæµå…³ç³»**
- å›¾ä»£ç†åŒ…å«å¤šä¸ªèŠ‚ç‚¹ (GraphNode)
- å›¾ä»£ç†å®šä¹‰å¤šä¸ªè¾¹ (GraphEdge)

**æä¾›è€…å…³ç³»**
- æä¾›è€…å®šä¹‰å¤šä¸ªå·¥å…· (Tool)

### å…³é”®æ¨¡å‹è¯¦è§£

#### User ä¸Šä¸‹æ–‡

è™½ç„¶ User ä¿¡æ¯ä¸ç›´æ¥å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œä½†é€šè¿‡ \`user_id\` å’Œ \`auth_provider\` å­—æ®µç»´æŠ¤ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼š
- å¤šç§Ÿæˆ·éš”ç¦»ï¼šæ¯ä¸ª user_id æ‹¥æœ‰ç‹¬ç«‹çš„ agentsã€sessions ç­‰
- è®¤è¯æä¾›è€…è·Ÿè¸ªï¼šæ”¯æŒå¤šä¸ªèº«ä»½æä¾›è€…

#### Agent (ä»£ç†)

```python
class Agent(SQLModel, table=True):
    # åŸºæœ¬ä¿¡æ¯
    name: str              # ä»£ç†åç§°
    description: str       # ä»£ç†æè¿°
    avatar: str            # å¤´åƒ URL
    tags: list[str]        # æ ‡ç­¾åˆ†ç±»
    
    # é…ç½®
    model: str             # ä½¿ç”¨çš„ LLM æ¨¡å‹
    temperature: float     # æ¸©åº¦å‚æ•° (0-1)
    prompt: str            # ç³»ç»Ÿæç¤ºè¯
    
    # å…³è”
    user_id: str           # æ‰€æœ‰è€…ç”¨æˆ· ID
    provider_id: UUID      # å…³è”çš„æä¾›è€… UUID
    
    # å·¥å…·ç¡®è®¤
    require_tool_confirmation: bool  # è°ƒç”¨å·¥å…·å‰æ˜¯å¦éœ€è¦ç”¨æˆ·ç¡®è®¤
    
    # æ—¶é—´æˆ³
    created_at: datetime   # åˆ›å»ºæ—¶é—´
    updated_at: datetime   # æ›´æ–°æ—¶é—´
```

#### Session & Topic & Message

ä¼šè¯æ˜¯å¤šè½®å¯¹è¯çš„å®¹å™¨ï¼š
- **Session**: ä¸€æ¬¡å®Œæ•´çš„ä¼šè¯ï¼ŒåŒ…å«ä¸€ä¸ªé»˜è®¤ä¸»é¢˜
- **Topic**: ä¸»é¢˜æ˜¯æ¶ˆæ¯çš„åˆ†ç»„ï¼Œä¸€ä¸ªä¼šè¯å¯æœ‰å¤šä¸ªä¸»é¢˜
- **Message**: å•æ¡æ¶ˆæ¯ï¼ŒåŒ…å« role (user/assistant) å’Œ content

```python
# åˆ›å»ºæµç¨‹
POST /sessions
  â””â”€ è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Topic
      â””â”€ Topic åŒ…å« Messages
```

#### GraphAgent (å›¾ä»£ç†)

åŸºäº LangGraph çš„å·¥ä½œæµä»£ç†ï¼š

```python
class GraphAgent(SQLModel, table=True):
    name: str
    description: str
    state_schema: dict    # JSON - å®šä¹‰çŠ¶æ€ç»“æ„
    is_active: bool       # æ˜¯å¦æ¿€æ´»
    is_published: bool    # æ˜¯å¦å‘å¸ƒ
    is_official: bool     # æ˜¯å¦ä¸ºå®˜æ–¹ä»£ç†
    parent_agent_id: UUID # ç‰ˆæœ¬æ§åˆ¶ - æŒ‡å‘ä¸Šä¸€ç‰ˆæœ¬
```

#### ConsumeRecord (æ¶ˆè´¹è®°å½•)

è®°å½•æ¯æ¬¡ API ä½¿ç”¨çš„æ¶ˆè´¹ï¼š

```python
class ConsumeRecord(SQLModel, table=True):
    user_id: str           # ç”¨æˆ· ID
    amount: int            # æ¶ˆè´¹æ•°é‡
    auth_provider: str     # è®¤è¯æä¾›è€…
    
    # ä¸šåŠ¡å…³è”
    session_id: UUID       # å…³è”çš„ä¼šè¯
    topic_id: UUID         # å…³è”çš„ä¸»é¢˜
    message_id: UUID       # å…³è”çš„æ¶ˆæ¯
    
    # è®¡è´¹çŠ¶æ€
    consume_state: str     # pending/success/failed
    remote_response: str   # è¿œç¨‹è®¡è´¹ç³»ç»Ÿå“åº”
    
    # å¹‚ç­‰æ€§
    biz_no: int           # ä¸šåŠ¡ç¼–å·ï¼ˆè‡ªå¢ï¼Œç”¨äºå»é‡ï¼‰
```

## é€šä¿¡æµç¨‹

### è¯·æ±‚-å“åº”æµç¨‹

```mermaid
sequenceDiagram
    participant Client
    participant API as API Handler
    participant Auth as Auth Middleware
    participant Service as Service Layer
    participant Repo as Repository
    participant DB as Database
    
    Client->>API: HTTP Request + Bearer Token
    API->>Auth: éªŒè¯ Token
    Auth->>Auth: æå– user_id & provider
    Auth->>Service: æ³¨å…¥ç”¨æˆ·ä¸Šä¸‹æ–‡
    Service->>Repo: è°ƒç”¨ CRUD æ–¹æ³•
    Repo->>DB: SQL æŸ¥è¯¢/æ’å…¥/æ›´æ–°
    DB->>Repo: è¿”å›ç»“æœ
    Repo->>Service: è¿”å›æ•°æ®
    Service->>Service: ä¸šåŠ¡é€»è¾‘å¤„ç†
    Service->>API: è¿”å›å“åº”
    API->>Client: HTTP Response (JSON)
```

### WebSocket æµç¨‹

```mermaid
sequenceDiagram
    participant Client
    participant WS as WebSocket Handler
    participant Chat as Chat Service
    participant LLM as LLM Provider
    
    Client->>WS: WebSocket è¿æ¥
    WS->>WS: è®¤è¯å’Œåˆå§‹åŒ–
    Client->>WS: å‘é€æ¶ˆæ¯
    WS->>Chat: æ‰§è¡ŒèŠå¤©é€»è¾‘
    Chat->>LLM: è°ƒç”¨ LLM API
    LLM->>Chat: æµå¼å“åº”
    Chat->>WS: è½¬å‘æµ
    WS->>Client: WebSocket æ¶ˆæ¯ (åˆ†å—)
    Client->>WS: å…³é—­è¿æ¥
```

## ç”Ÿå‘½å‘¨æœŸç®¡ç†

### åº”ç”¨å¯åŠ¨æµç¨‹

```mermaid
graph TD
    A["åº”ç”¨å¯åŠ¨"] -->|lifespan ä¸Šä¸‹æ–‡| B["åˆ›å»ºæ•°æ®åº“è¡¨<br/>create_db_and_tables"]
    B --> C["åˆå§‹åŒ–æä¾›è€…<br/>initialize_providers_on_startup"]
    C --> D["åˆå§‹åŒ–ç³»ç»Ÿä»£ç†<br/>Chat Agent & Workshop Agent"]
    D --> E["ç§å­åŒ–å†…ç½®å›¾ä»£ç†<br/>builtin_agents.seed_to_database"]
    E --> F["è®¾ç½® MCP æœåŠ¡å™¨<br/>create MCP HTTP apps"]
    F --> G["å¯åŠ¨ FastAPI åº”ç”¨"]
    G --> H["å‡†å¤‡æ¥æ”¶è¯·æ±‚"]
```

### å…³é”®å¯åŠ¨æ­¥éª¤

1. **æ•°æ®åº“è¡¨åˆ›å»º**: ä½¿ç”¨ SQLModel åˆ›å»ºæˆ–è¿ç§»æ‰€æœ‰è¡¨
2. **æä¾›è€…åˆå§‹åŒ–**: ä»ç¯å¢ƒå˜é‡åŠ è½½ API å¯†é’¥
3. **ç³»ç»Ÿä»£ç†åˆ›å»º**: ç¡®ä¿ Chat å’Œ Workshop ä»£ç†å­˜åœ¨
4. **å†…ç½®ä»£ç†ç§å­åŒ–**: å°†é¢„å®šä¹‰çš„å›¾ä»£ç†åŠ è½½åˆ°æ•°æ®åº“
5. **MCP æœåŠ¡å™¨è®¾ç½®**: ä¸ºæ¯ä¸ªå·²æ³¨å†Œçš„ MCP æœåŠ¡å™¨åˆ›å»º HTTP åº”ç”¨
6. **ç”Ÿå‘½å‘¨æœŸä¸Šä¸‹æ–‡ç®¡ç†**: ä½¿ç”¨ AsyncExitStack ç®¡ç†æ‰€æœ‰å¼‚æ­¥èµ„æº

## API è®¾è®¡æ¨¡å¼

### RESTful è®¾è®¡

éµå¾ª REST æœ€ä½³å®è·µï¼š

| HTTP æ–¹æ³• | æ“ä½œ | è·¯ç”±ç¤ºä¾‹ |
|----------|------|---------|
| GET | è¯»å– | /agents åˆ—è¡¨ï¼Œ/agents/id è¯¦æƒ… |
| POST | åˆ›å»º | /agents åˆ›å»ºæ–°ä»£ç†ï¼Œè‡ªåŠ¨å…³è” user_id |
| PUT | æ›´æ–° | /agents/id æ›´æ–°ä»£ç†é…ç½® |
| DELETE | åˆ é™¤ | /agents/id åˆ é™¤ä»£ç† |

### è¯·æ±‚/å“åº”æ¨¡å¼

**è¯·æ±‚æ¨¡å‹** (Pydantic)

```python
class AgentCreate(SQLModel):
    name: str
    description: str | None = None
    model: str | None = None
    temperature: float | None = None
    provider_id: UUID | None = None
    mcp_server_ids: list[UUID] = []
```

**å“åº”æ¨¡å¼**

```python
class AgentRead(AgentBase):
    id: UUID
    created_at: datetime
    updated_at: datetime
    # å…³è”æ•°æ®
    mcp_servers: list[MCPServerRead]
    provider: ProviderRead
```

### é”™è¯¯å¤„ç†

ç»Ÿä¸€çš„ HTTP å¼‚å¸¸å¤„ç†ï¼š

- 400 Bad Request - è¯·æ±‚å‚æ•°é”™è¯¯
- 401 Unauthorized - è®¤è¯å¤±è´¥
- 403 Forbidden - æƒé™ä¸è¶³
- 404 Not Found - èµ„æºä¸å­˜åœ¨
- 409 Conflict - ä¸šåŠ¡å†²çª (å¦‚é‡å)
- 500 Internal Server Error - æœåŠ¡é”™è¯¯

## å¤–éƒ¨é›†æˆ

### LLM æä¾›è€…é›†æˆ

\`\`\`mermaid
graph LR
    ChatService["Chat Service<br/>core/chat/"] -->|langchain| OpenAI["OpenAI"]
    ChatService -->|langchain| Claude["Anthropic Claude"]
    ChatService -->|langchain| Gemini["Google Gemini"]
    ChatService -->|langchain| Azure["Azure OpenAI"]
    
    style ChatService fill:#fce4ec
    style OpenAI fill:#bbdefb
    style Claude fill:#bbdefb
    style Gemini fill:#bbdefb
    style Azure fill:#bbdefb
\`\`\`

é€šè¿‡ LangChain çš„ LLMBase æŠ½è±¡ï¼Œæ”¯æŒå¤šä¸ª LLM æä¾›è€…ã€‚æ¯ä¸ªæä¾›è€…é€šè¿‡ \`Provider\` æ¨¡å‹å­˜å‚¨å…¶ API å¯†é’¥å’Œé…ç½®ã€‚

### MCP (Model Context Protocol) é›†æˆ

MCP æä¾›å·¥å…·å’Œèµ„æºçš„æ ‡å‡†åŒ–æ¥å£ï¼š

1. **MCP æœåŠ¡å™¨æ³¨å†Œ**: åœ¨ `handler/mcp/` ä¸­æ³¨å†Œ MCP æœåŠ¡å™¨
2. **å·¥å…·å‘ç°**: é€šè¿‡ Smithery æ³¨å†Œè¡¨å‘ç°å¯ç”¨å·¥å…·
3. **å·¥å…·è°ƒç”¨**: Chat Service é€šè¿‡ MCP è°ƒç”¨å¤–éƒ¨å·¥å…·
4. **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥ MCP æœåŠ¡å™¨å¯ç”¨æ€§

### LangChain & LangGraph

- **LangChain**: ç”¨äºæ„å»ºç®€å•çš„ LLM è°ƒç”¨é“¾
- **LangGraph**: ç”¨äºæ„å»ºå¤æ‚çš„å·¥ä½œæµå›¾ (çŠ¶æ€æœº)

Graph Agents åˆ©ç”¨ LangGraph å®šä¹‰ï¼š
- **Nodes**: æ‰§è¡Œæ­¥éª¤ (LLM è°ƒç”¨ã€å·¥å…·è°ƒç”¨ç­‰)
- **Edges**: æ¡ä»¶è½¬ç§»é€»è¾‘
- **State Schema**: æ•´ä¸ªå·¥ä½œæµçš„çŠ¶æ€å®šä¹‰

## éƒ¨ç½²æ¶æ„

### Docker å®¹å™¨åŒ–

```dockerfile
# åŸºç¡€é•œåƒ: Python 3.13.5-slim
FROM python:3.13.5-slim

# ä¾èµ–ç®¡ç†: uv (å¿«é€Ÿ Python åŒ…ç®¡ç†å™¨)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# ç¯å¢ƒå˜é‡
ENV TZ=Asia/Shanghai
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# å®‰è£…ä¾èµ–
RUN uv sync --locked

# æš´éœ²ç«¯å£
EXPOSE 48196

# å¯åŠ¨å‘½ä»¤
CMD ["uv", "run", "python", "-m", "app.main"]
```

### ç¯å¢ƒé…ç½®

é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®åº”ç”¨ï¼š

```bash
# æ•°æ®åº“
DATABASE_URL=postgresql://user:password@host:5432/xyzen

# LLM æä¾›è€…
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
GOOGLE_API_KEY=...

# è®¤è¯
CASDOOR_ENDPOINT=https://...
BOHRIUM_API_KEY=...

# åº”ç”¨
DEBUG=false
HOST=0.0.0.0
PORT=48196
```

### å¤šç¯å¢ƒéƒ¨ç½²

- **å¼€å‘ç¯å¢ƒ**: SQLite + å¿«é€Ÿè¿­ä»£
- **æµ‹è¯•ç¯å¢ƒ**: PostgreSQL + å®Œæ•´åŠŸèƒ½æµ‹è¯•
- **ç”Ÿäº§ç¯å¢ƒ**: PostgreSQL + é«˜å¯ç”¨é…ç½® + ç›‘æ§æ—¥å¿—

## æŠ€æœ¯æ ˆæ€»ç»“

| åˆ†å±‚ | æŠ€æœ¯ | è¯´æ˜ |
|-----|------|------|
| **Web æ¡†æ¶** | FastAPI | é«˜æ€§èƒ½å¼‚æ­¥ Web æ¡†æ¶ |
| **å¼‚æ­¥è¿è¡Œæ—¶** | AsyncIO | Python å¼‚æ­¥ç¼–ç¨‹ |
| **ORM** | SQLModel + SQLAlchemy | ç±»å‹å®‰å…¨çš„ ORM |
| **æ•°æ®åº“** | PostgreSQL / SQLite | å…³ç³»å‹æ•°æ®åº“ |
| **è¿ç§»å·¥å…·** | Alembic | æ•°æ®åº“ç‰ˆæœ¬ç®¡ç† |
| **AI/Agent** | LangChain | LLM è°ƒç”¨æ¡†æ¶ |
| **å·¥ä½œæµå¼•æ“** | LangGraph | å¤æ‚ä¸šåŠ¡æµç¨‹ç¼–æ’ |
| **å®æ—¶é€šä¿¡** | WebSocket | åŒå‘å®æ—¶é€šä¿¡ |
| **å·¥å…·åè®®** | MCP | æ ‡å‡†åŒ–å·¥å…·æ¥å£ |
| **å®¹å™¨åŒ–** | Docker | æ ‡å‡†åŒ–éƒ¨ç½² |
| **åŒ…ç®¡ç†** | uv | å¿«é€Ÿä¾èµ–ç®¡ç† |
| **è®¤è¯** | JWT + å¤šæä¾›è€… | å®‰å…¨èº«ä»½éªŒè¯ |
| **æ—¥å¿—** | ç»“æ„åŒ–æ—¥å¿— | ä¾¿äºè°ƒè¯•å’Œç›‘æ§ |

## è®¾è®¡åŸåˆ™

### 1. å…³æ³¨ç‚¹åˆ†ç¦» (Separation of Concerns)

æ¯ä¸ªæ¨¡å—ä¸“æ³¨äºå•ä¸€èŒè´£ï¼š
- API Handler: è¯·æ±‚/å“åº”å¤„ç†
- Service: ä¸šåŠ¡é€»è¾‘
- Repository: æ•°æ®è®¿é—®
- Model: æ•°æ®å®šä¹‰

### 2. ä¾èµ–æ³¨å…¥ (Dependency Injection)

ä½¿ç”¨ FastAPI çš„ `Depends` æœºåˆ¶å®ç°ï¼š

```python
async def get_current_user(token: str = Depends(oauth2_scheme)) -> User:
    return validate_token(token)

@router.get("/agents")
async def list_agents(current_user: User = Depends(get_current_user)):
    return await agent_service.list_agents(current_user.id)
```

### 3. å¼‚æ­¥ä¼˜å…ˆ (Async-First)

å……åˆ†åˆ©ç”¨ Python AsyncIOï¼š
- éé˜»å¡ I/O æ“ä½œ
- é«˜å¹¶å‘å¤„ç†èƒ½åŠ›
- æ›´å¥½çš„èµ„æºåˆ©ç”¨

### 4. ç±»å‹å®‰å…¨ (Type Safety)

ä½¿ç”¨ Python ç±»å‹æ³¨è§£å’Œ Pydanticï¼š
- ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- è¿è¡Œæ—¶æ•°æ®éªŒè¯
- æ›´å¥½çš„ IDE æ”¯æŒ

### 5. å¤šç§Ÿæˆ·éš”ç¦» (Multi-Tenancy)

é€šè¿‡ `user_id` å­—æ®µå®ç°ï¼š
- æ¯ä¸ªç”¨æˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
- æ•°æ®åº“æŸ¥è¯¢è‡ªåŠ¨å¸¦ä¸Š user_id è¿‡æ»¤
- æ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘å³å¯æ”¯æŒå¤šç”¨æˆ·

## å¯æ‰©å±•æ€§è€ƒè™‘

### æ°´å¹³æ‰©å±•

- **æ— çŠ¶æ€ API**: å¯è¿è¡Œå¤šä¸ªå‰¯æœ¬
- **å…±äº«æ•°æ®åº“**: PostgreSQL æ”¯æŒå¹¶å‘è®¿é—®
- **è´Ÿè½½å‡è¡¡**: é€šè¿‡ Nginx/HAProxy åˆ†å‘è¯·æ±‚

### å‚ç›´æ‰©å±•

- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨åå°ä»»åŠ¡å¤„ç†è€—æ—¶æ“ä½œ
- **ç¼“å­˜å±‚**: å¯æ·»åŠ  Redis ç¼“å­˜çƒ­æ•°æ®
- **CDN**: é™æ€èµ„æºé€šè¿‡ CDN åŠ é€Ÿ

### åŠŸèƒ½æ‰©å±•

- **æ’ä»¶ç³»ç»Ÿ**: MCP æœåŠ¡å™¨ä½œä¸ºæ’ä»¶æœºåˆ¶
- **è‡ªå®šä¹‰ Agent**: ç”¨æˆ·å¯åˆ›å»ºè‡ªå·±çš„ä»£ç†
- **å·¥ä½œæµç¼–æ’**: LangGraph æ”¯æŒå¤æ‚å·¥ä½œæµ

<Note>
å®Œæ•´çš„æ¶æ„æ–‡æ¡£æ¶µç›–äº†ä»å®è§‚ç³»ç»Ÿè®¾è®¡åˆ°å¾®è§‚å®ç°ç»†èŠ‚çš„å„ä¸ªå±‚é¢ã€‚å»ºè®®ç»“åˆ[é«˜çº§åŠŸèƒ½](../advanced)æ–‡æ¡£äº†è§£å…·ä½“åŠŸèƒ½ï¼Œä»¥åŠ[API å‚è€ƒ](../api)äº†è§£æ¥å£ç»†èŠ‚ã€‚
</Note>
